<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <title>Payment</title>
</head>
<body>
<h2>Payment (Mock)</h2>

<table border="1" cellpadding="6" cellspacing="0" th:if="${!#lists.isEmpty(items)}">
  <tr><th>สินค้า</th><th>จำนวน</th><th>ราคา/ชิ้น</th><th>รวม</th></tr>
  <tr th:each="it : ${items}">
    <td th:text="${it.product.name}">Product</td>
    <td th:text="${it.quantity}">1</td>
    <td th:text="${#numbers.formatDecimal(it.product.price,1,2)}">0.00</td>
    <td th:text="${#numbers.formatDecimal(it.product.price * it.quantity,1,2)}">0.00</td>
  </tr>
</table>

<h3 th:if="${!#lists.isEmpty(items)}">
  ยอดรวม: <span th:text="${#numbers.formatDecimal(total,1,2)}">0.00</span> บาท
</h3>

<!-- ฟอร์มบัตรเครดิต -->
<form id="payForm">
  <input type="hidden" id="method" value="card">

  <fieldset style="max-width:420px">
    <legend>Credit/Debit Card</legend>

    <label>Card number
      <input type="text" id="cardNumber" maxlength="19" inputmode="numeric"
             placeholder="4111 1111 1111 1111"
             oninput="this.value=this.value.replace(/[^0-9 ]/g,'').slice(0,19)"
             required>
    </label><br><br>

    <label>Name on card
      <input type="text" id="cardName" required>
    </label><br><br>

    <label>Expiry</label>
    <input type="text" id="expMonth" maxlength="2" inputmode="numeric" placeholder="MM"
           oninput="this.value=this.value.replace(/\\D/g,'').slice(0,2)"
           required style="width:40px;text-align:center;">
    <span>/</span>
    <input type="text" id="expYear" maxlength="2" inputmode="numeric" placeholder="YY"
           oninput="this.value=this.value.replace(/\\D/g,'').slice(0,2)"
           required style="width:40px;text-align:center;">

    <label style="margin-left:12px;">CVV
      <input type="password" id="cvv" maxlength="4" inputmode="numeric"
             oninput="this.value=this.value.replace(/\\D/g,'').slice(0,4)"
             required>
    </label>
  </fieldset>

  <br>
  <button type="submit" th:disabled="${#lists.isEmpty(items)}">Pay</button>
</form>

<div id="msg" style="color:red; margin-top:10px;"></div>

<p style="margin-top:12px;"><a th:href="@{/cart}">← Back to Cart</a></p>

<script>
  const form = document.getElementById('payForm');
  const msg = document.getElementById('msg');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.textContent = '';

    const body = {
      method: document.getElementById('method').value,
      cardNumber: document.getElementById('cardNumber').value,
      cardName: document.getElementById('cardName').value,
      expMonth: document.getElementById('expMonth').value,
      expYear: document.getElementById('expYear').value,
      cvv: document.getElementById('cvv').value
    };

    try {
      const res = await fetch('/api/payment/confirm', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const text = await res.text();
        msg.textContent = 'ชำระเงินไม่สำเร็จ: ' + text;
        return;
      }

      const data = await res.json(); // { orderId, total }
      // ไปหน้า success ของ Thymeleaf
      window.location.href = '/payment/success/' + data.orderId;
    } catch (err) {
      msg.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ';
    }
  });
</script>
</body>
</html>
